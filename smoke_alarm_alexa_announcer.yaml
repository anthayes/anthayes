blueprint:
  name: X-Sense Smoke Alarm Alexa Announcer (Multi-Detector)
  description: Monitor multiple X-Sense smoke alarms (20+) and announce alerts on Alexa devices. Create one automation per detector or use a group.
  domain: automation
  input:
    # Smoke Detector Group or Single Entity
    smoke_detector_trigger:
      name: Smoke Detector Trigger
      description: Single smoke detector entity, group, or area to monitor
      selector:
        entity:
          domain: 
            - binary_sensor
            - group
    
    # Alexa Devices
    alexa_devices:
      name: Alexa Devices
      description: Alexa devices to announce on (can select multiple)
      selector:
        target:
          entity:
            domain: media_player
            integration: alexa_media
    
    # Announcement Settings
    announcement_volume:
      name: Announcement Volume
      description: Volume level for announcements (0.0 to 1.0)
      default: 0.8
      selector:
        number:
          min: 0.0
          max: 1.0
          step: 0.1
          mode: slider
    
    repeat_announcements:
      name: Repeat Announcements
      description: Number of times to repeat the announcement
      default: 3
      selector:
        number:
          min: 1
          max: 10
          mode: slider
    
    repeat_delay:
      name: Delay Between Repeats
      description: Seconds to wait between repeated announcements
      default: 5
      selector:
        number:
          min: 1
          max: 30
          unit_of_measurement: seconds
    
    # Fallback room name
    fallback_room_name:
      name: Fallback Room Name
      description: Room name to use if area/room cannot be determined
      default: "unknown location"
      selector:
        text:

mode: parallel
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input smoke_detector_trigger
    to: "on"

action:
  - alias: "Set volume on Alexa devices"
    action: media_player.volume_set
    target: !input alexa_devices
    data:
      volume_level: !input announcement_volume
  
  - alias: "Get triggered detector info and announce"
    variables:
      triggered_entity: "{{ trigger.entity_id }}"
      device_id: "{{ device_id(triggered_entity) if triggered_entity.startswith('binary_sensor.') else none }}"
      area_name: >
        {% if device_id %}
          {% set area_id = area_id(device_id) %}
          {% if area_id %}
            {{ area_name(area_id) }}
          {% else %}
            !input fallback_room_name
          {% endif %}
        {% else %}
          !input fallback_room_name
        {% endif %}
      friendly_name: "{{ state_attr(triggered_entity, 'friendly_name') or triggered_entity }}"
  
  - repeat:
      count: !input repeat_announcements
      sequence:
        - alias: "Announce smoke detected with room info"
          action: notify.alexa_media
          data:
            target: !input alexa_devices
            message: >
              Alert! Smoke has been detected in the {{ area_name }}. 
              Detector: {{ friendly_name }}. 
              Please evacuate immediately and check for fire.
            data:
              type: announce
              method: speak
        - delay: !input repeat_delay